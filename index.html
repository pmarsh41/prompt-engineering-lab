<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Feedback Counter</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8 bg-gray-100">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow">
        <h1 class="text-2xl font-bold mb-4">Feedback Counter Test</h1>
        
        <div class="mb-4">
            <p class="text-sm text-gray-600 mb-2">Current counts: <span id="count-display" class="font-mono"></span></p>
            <button id="reset-counts" class="text-sm bg-red-500 text-white px-2 py-1 rounded">Reset All Counts</button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block font-medium mb-1">Role & Objective</label>
                <textarea id="role" class="w-full border rounded p-2" rows="3" placeholder="Type something here..."></textarea>
                <button class="feedback-btn mt-2 bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-1 rounded" data-target="role">
                    ‚ú® Get Feedback (<span class="count">0</span>)
                </button>
                <div id="role-feedback" class="mt-2 p-3 bg-blue-50 rounded hidden"></div>
            </div>
            
            <div>
                <label class="block font-medium mb-1">Instructions: Dos</label>
                <textarea id="dos" class="w-full border rounded p-2" rows="3" placeholder="Type something here..."></textarea>
                <button class="feedback-btn mt-2 bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-1 rounded" data-target="dos">
                    ‚ú® Get Feedback (<span class="count">0</span>)
                </button>
                <div id="dos-feedback" class="mt-2 p-3 bg-blue-50 rounded hidden"></div>
            </div>
        </div>
        
        <div class="mt-6 p-4 bg-gray-100 rounded">
            <h3 class="font-bold mb-2">Debug Log:</h3>
            <div id="debug-log" class="text-xs font-mono space-y-1"></div>
        </div>
    </div>

    <script>
        // Initialize feedback counts
        let feedbackCounts = JSON.parse(localStorage.getItem('test_feedback_counts')) || {};
        
        function log(message) {
            const logDiv = document.getElementById('debug-log');
            const entry = document.createElement('div');
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logDiv.appendChild(entry);
            console.log(message);
        }
        
        function updateCountDisplay() {
            document.getElementById('count-display').textContent = JSON.stringify(feedbackCounts);
            
            // Update individual button counts
            document.querySelectorAll('.feedback-btn').forEach(btn => {
                const targetId = btn.dataset.target;
                const count = feedbackCounts[targetId] || 0;
                btn.querySelector('.count').textContent = count;
            });
        }
        
        // Initial display
        updateCountDisplay();
        log('Page loaded, counts: ' + JSON.stringify(feedbackCounts));
        
        // Reset button
        document.getElementById('reset-counts').addEventListener('click', () => {
            feedbackCounts = {};
            localStorage.setItem('test_feedback_counts', JSON.stringify(feedbackCounts));
            updateCountDisplay();
            
            // Reset button colors
            document.querySelectorAll('.feedback-btn').forEach(btn => {
                btn.classList.remove('bg-green-100', 'text-green-700', 'hover:bg-green-200');
                btn.classList.add('bg-blue-100', 'text-blue-700', 'hover:bg-blue-200');
            });
            
            // Hide feedback boxes
            document.querySelectorAll('[id$="-feedback"]').forEach(box => {
                box.classList.add('hidden');
            });
            
            log('Counts reset');
        });
        
        // Feedback buttons
        document.querySelectorAll('.feedback-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const btn = e.currentTarget;
                const targetId = btn.dataset.target;
                const textarea = document.getElementById(targetId);
                const feedbackBox = document.getElementById(`${targetId}-feedback`);
                
                if (!textarea.value.trim()) {
                    feedbackBox.innerHTML = "Please write something first!";
                    feedbackBox.classList.remove('hidden');
                    log(`Empty field for ${targetId}`);
                    return;
                }
                
                // Track feedback count
                if (!feedbackCounts[targetId]) {
                    feedbackCounts[targetId] = 0;
                }
                feedbackCounts[targetId]++;
                localStorage.setItem('test_feedback_counts', JSON.stringify(feedbackCounts));
                
                log(`Feedback clicked for ${targetId}, count now: ${feedbackCounts[targetId]}`);
                
                // After 2 feedback requests, show only the nudge message (no API call)
                if (feedbackCounts[targetId] > 2) {
                    feedbackBox.innerHTML = `<strong>Progress Check:</strong><br><br><em style="color: #059669;">üí° You've received 2 rounds of feedback on this field. Great work! Now it's time to move forward and test your complete prompt. You can always refine it later based on real results.</em><br><br>üí™ <strong>Next step:</strong> Complete the other fields and test your prompt with real queries.`;
                    feedbackBox.classList.remove('hidden');
                    
                    // Change button color
                    btn.classList.remove('bg-blue-100', 'text-blue-700', 'hover:bg-blue-200');
                    btn.classList.add('bg-green-100', 'text-green-700', 'hover:bg-green-200');
                    
                    log(`No more API calls for ${targetId} - showing nudge only`);
                    updateCountDisplay();
                    return;
                }
                
                // Simulate API response for first 2 attempts
                let feedbackContent = `<strong>Coach's Corner:</strong><br>This is feedback #${feedbackCounts[targetId]} for the ${targetId} field. [Simulated Socratic question here]`;
                
                if (feedbackCounts[targetId] === 2) {
                    feedbackContent += `<br><br><em style="color: #1e40af;">üìù This is your second round of feedback for this field. After this, focus on completing your full prompt!</em>`;
                }
                
                log(`Showing coach feedback #${feedbackCounts[targetId]} for ${targetId}`);
                
                feedbackBox.innerHTML = feedbackContent;
                feedbackBox.classList.remove('hidden');
                
                updateCountDisplay();
            });
        });
    </script>
</body>
</html>
